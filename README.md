
* STM32 工程（motor）

---

# 项目说明文档

## 1. 项目概述

本项目包含两个部分：

1. **STM32 控制系统工程**（32 工程）
2. **上位机控制与参数调试程序**

两者通过串口通信实现数据交互，包括速度展示、PID 参数下发及控制指令发送。

---

## 2. STM32 工程说明

### 2.1 工程结构概述

* 编码器采集速度并计算实际转速
* 主循环或定时器负责更新 `speedM`
* USART 实现与上位机通讯
* DMA 用于串口发送提高效率
* 通过上位机下发 PID 参数并实时更新控制器
* 使用 PWM 输出控制电机

### 2.2 编码器模块

* 使用定时器捕获计数值
* 通过 `encoder_val` 计算速度
* 更新为全局变量 `speedM`，供主控与显示使用

速度计算流程：

1. 读取定时器计数
2. 计算增量 `delta`
3. 换算成实际转速
4. 得到 `speedM`

### 2.3 PID 控制模块

PID 参数通过上位机下发，格式如下：

```
P=1.200,I=0.050,D=0.100,T=120.000
```

STM32 解析逻辑示例：

1. 以逗号分割
2. 取出每段的数值
3. 更新 `kp, ki, kd, target`

控制流程：

1. 每周期读取 `speedM`
2. 调用 PID 计算控制量
3. 通过 PWM 输出控制

### 2.4 串口通讯模块

通讯采用 **USART + DMA**方式。

* 上位机 → STM32：参数下发 + 控制指令
* STM32 → 上位机：速度、状态信息回传
* 数据格式统一采用 ASCII 文本

发送数据示例：

```
+1.234\r\n
```

接收数据示例：

```
P=1.200,I=0.050,D=0.100,T=0.800\r\n
```

解析流程：

1. 查找关键字符 '='
2. 使用 `atof()` 将数字转为浮点
3. 更新 PID 参数或目标速度

---

## 3. 上位机程序说明

上位机负责参数调试、速度显示和命令下发，可使用 Python、C# 或 Qt 实现。

### 3.1 功能概述

1. 实时显示电机速度
2. 修改 PID 参数
3. 设置目标速度
4. 发送控制指令（启动/停止）
5. 可记录数据用于调试

### 3.2 串口协议说明

上位机 → STM32：

```
P={kp},I={ki},D={kd},T={target}\r\n
```

STM32 → 上位机：

```
SPD={speed}\r\n
```

控制指令示例：

```
CMD=START
CMD=STOP
```

### 3.3 参数设置界面说明

* 输入框用于设置 `kp, ki, kd`
* 目标速度输入框 `target`
* “发送参数”按钮
* “读取当前参数”按钮（可选）
* 实时显示曲线（速度反馈）

---

## 4. 工程运行流程说明

1. 上电初始化
2. 编码器开始采集实时转速
3. PID 根据 `target` 调整 PWM 输出
4. 实时通过串口回传速度
5. 上位机根据需要调整 PID 参数
6. 上位机绘制速度变化曲线（可选）

---

## 5. 注意事项

1. 串口通信建议使用固定格式，避免解析歧义
2. 浮点数以小数格式发送，例如 `1.234`
3. PID 参数尽量限制在合理范围

---

## 6. 后续可扩展内容

* 增加指令校验（CRC 或简单校验和）
* 增加 EEPROM 保存参数
* 上位机支持曲线回放
* 增加自动整定 PID（Z-N 法等）

