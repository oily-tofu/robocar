import cv2
import numpy as np
import random

#cqupt很不高兴为您服务@_@

img = cv2.imread(r"D:/ros/26rc-yolo/kfs/1h.png")
img_back = np.zeros((640, 640, 4), dtype=np.uint8)

rows, cols = 4, 4
block_size = 640 // rows

#绿色布景生成
def random_green():
    g = random.randint(150, 255)
    r = random.randint(0, g // 2)
    b = random.randint(0, g // 3)
    return b, g, r, 255  # alpha=255

for i in range(rows):
    for j in range(cols):
        color = random_green()
        x1, y1 = j*block_size, i*block_size
        x2, y2 = x1 + block_size, y1 + block_size
        cv2.rectangle(img_back, (x1, y1), (x2, y2), color, -1)

#kfs原图处理

if img is None:
    raise ValueError("图片路径错误或文件不存在")

h, w = img.shape[:2]


img_rgba = cv2.cvtColor(img, cv2.COLOR_BGR2BGRA)
img_rgba[:, :, 3] = 255


threshold = 10

alpha = np.ones((h, w), dtype=np.uint8) * 255


border = 10
mask_black = (
    (img[:,:,0] < threshold) &
    (img[:,:,1] < threshold) &
    (img[:,:,2] < threshold)
)

mask_black[border:-border, border:-border] = False

alpha[mask_black] = 0
img_rgba[:, :, 3] = alpha

center = (w // 2, h // 2)

#旋转透视变换
pts1 = np.float32([[0,0],[w-1,0],[w-1,h-1],[0,h-1]])
t1, t2 = random.uniform(0,0.3), random.uniform(0.7,1)
t3, t4 = random.uniform(0,0.3), random.uniform(0.7,1)
t5, t6 = random.uniform(0.9,1), random.uniform(0.9,1)
pts2 = np.float32([[w*t1,0],[w*t2,0],[w*t4,h*t6],[w*t3,h*t5]])
M_persp = cv2.getPerspectiveTransform(pts1, pts2)
warped = cv2.warpPerspective(img_rgba, M_persp, (w,h))

angle = random.randint(0,360)
scale = 0.5
M_rot = cv2.getRotationMatrix2D(center, angle, scale)
rotated = cv2.warpAffine(warped, M_rot, (w,h))

#图片叠加
h_r, w_r = rotated.shape[:2]
h_i, w_i = img_back.shape[:2]
x_offset = (w_i - w_r) // 2
y_offset = (h_i - h_r) // 2

b, g, r, a = cv2.split(rotated)
alpha = a / 255.0

roi = img_back[y_offset:y_offset+h_r, x_offset:x_offset+w_r]

for c, channel in enumerate([b,g,r]):
    roi[:,:,c] = np.where(alpha>0, channel, roi[:,:,c])

roi[:,:,3] = np.maximum(roi[:,:,3], a)

img_back[y_offset:y_offset+h_r, x_offset:x_offset+w_r] = roi



cv2.imshow("Rotated Centered", img_back)
cv2.waitKey(0)
cv2.destroyAllWindows()



#                                               .=%@#=.                                               
#                                             -*@@@@@@@#=.                                            
#                                          .+%@@@@@@@@@@@@#=                                          
#                                        -#@@@@@@@* =@@@@@@@@*:                                       
#                                      =%@@@@@@@@=   -@@@@@@@@@#-                                     
#                                   .+@@@@@@@@@@-     .@@@@@@@@@@%=                                   
#                                 .+@@@@@@@@@@@@-     +@@@@@@@@@@@@@+.                                
#                                +@@@@@@@@@@@@@@@    .@@@@@@@@@@@@@@@@+.                              
#                              =@@@@@@@@@@@@@@@%-     =%@@%@@@@@@@@@@@@@=                             
#                            -%@@@@@@@@@@@@+..     .       -@@@@@@@@@@@@@%-                           
#                          .#@@@@@@@@@@@@@#       -@+       +@@@@@@@@@@@@@@#:                         
#                         +@@@@@@@@@@@@@@@@+     +@@@+     =@@@@@@@@@@@@@@@@@+                        
#                       :%@@@@@@@@@@@@@@@@@+    *@@@@*     =@@@@@@@@@@@@@@@@@@%-                      
#                      +@@@@@@@@@@@@@@#+*+-   .#@@@@+       :+*+*@@@@@@@@@@@@@@@*                     
#                    :%@@@@@@@@@@@@@@+       :%@@@@-    .-       -@@@@@@@@@@@@@@@%:                   
#                   =@@@@@@@@@@@@@@@@-      -@@@@%:    .%@+      =@@@@@@@@@@@@@@@@@=                  
#                  *@@@@@@@@@@@@@@@@@@.    =@@@@#.    -@@@@+    =@@@@@@@@@@@@@@@@@@@#                 
#                .%@@@@@@@@@@@@@@@@@@+    +@@@@*     =@@@@%:    .#@@@@@@@@@@@@@@@@@@@%.               
#               :@@@@@@@@@@@@@@@%:::.    #@@@@+     +@@@@#        .::.*@@@@@@@@@@@@@@@@-              
#              -@@@@@@@@@@@@@@@%       .%@@@@=     *@@@@*     +-       *@@@@@@@@@@@@@@@@=             
#             =@@@@@@@@@@@@@@@@@#.    -@@@@@-    :%@@@@=    .#@@+     +@@@@@@@@@@@@@@@@@@=            
#            =@@@@@@@@@@@@@@@@@@@:    =====.     -+===:     :====     @@@@@@@@@@@@@@@@@@@@+           
#           +@@@@@@@@@@@@@@@#%%#-                                     :*%%#%@@@@@@@@@@@@@@@+          
#          =@@@@@@@@@@@@@@%.       ...........................              *@@@@@@@@@@@@@@@=         
#         =@@@@@@@@@@@@@@@+      .#@@@@@@@@@@@@@@@@@@@@@@@@@@#     .*:      =@@@@@@@@@@@@@@@@-        
#        -@@@@@@@@@@@@@@@@@=    .%@@@@@@@@@@@@@@@@@@@@@@@@@@#     :@@@-    =@@@@@@@@@@@@@@@@@@:       
#       :@@@@@@@@@@@@@@@@@%.   -@@@@%+=====================:     -@@@@%    :%@@@@@@@@@@@@@@@@@@.      
#       %@@@@@@@@@@@@@=-=:    =@@@@#.                           +@@@@#.      -=--%@@@@@@@@@@@@@%      
#      #@@@@@@@@@@@@@:       +@@@@*      ............. .       *@@@@*             %@@@@@@@@@@@@@+     
#     =@@@@@@@@@@@@@@#.     #@@@@+     +@@@@@@@@@@@@@@@#.    .#@@@@+     +#.     +@@@@@@@@@@@@@@@:    
#    .@@@@@@@@@@@@@@@@-   .%@@@@=     *@@@@@@@@@@@@@@@#     :%@@@@-     *@@%:    @@@@@@@@@@@@@@@@%    
#    %@@@@@@@@@@@%%%#=   :@@@@@:    .#@@@@+-----------     -@@@@@:     #@@@@=    :#%%%@@@@@@@@@@@@*   
#   =@@@@@@@@@@@=       -@@@@%.    :%@@@@-                =@@@@%.    .%@@@@=          :%@@@@@@@@@@@:  
#   @@@@@@@@@@@%.      =@@@@#     -@@@@%:    .:::-:      +@@@@#     :@@@@@:    .       +@@@@@@@@@@@#  
#  +@@@@@@@@@@@@@.    *@@@@*     =@@@@#.    -@@@@@:     #@@@@+     =@@@@%.    -@#     +@@@@@@@@@@@@@- 
# .@@@@@@@@@@@@@#    *@%@%=     +@@@@*     =@@@@#.    .#@@@%=     +@@@@#     =@@@%.   =@@@@@@@@@@@@@% 
# +@@@@@@@@*-==-                .          .           . ..       .....      .....     .=+=+@@@@@@@@@-
# %@@@@@@@+                                                                                 -@@@@@@@@#
# @@@@@@@-       =#%#=     -#%%#-     -#%%*.     +%%%*.    .*%%#=     :#%%#-     =%%%*.      .#@@@@@@@
# @@@@@@=.::::::*@@@@@*:::-@@@@@@-:::=@@@@@%::::*@@@@@#::::%@@@@@+:---@@@@@@=---+@@@@@%------:=@@@@@@@
# =@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@+
#  *@@@@@@@@@@@@@@@@@@@@@@@@@@@%%##**++===----:::::------===++***##%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@* 
#   -#@@@@@@@@@@@@@@@@%#*+=-:.                                        ..::-=+*##%@@@@@@@@@@@@@@@@@#-  
#     :=*%@@@@@%#*=-:                                                             .:-=+*#%%%%##+-.    
                                                                                        
#         K####      #####     ###    ###  ######.   ##########     K##    ### ###    ##W    ####W    
#        #######    #######    ###    ###  ########  ##########     ###    ### ###   ###   W######    
#       W###G####  ###W ####   ###    ###  ######### ##########     ###    ###  ##   ###   ###W####   
#       ###   ###  ###   ###   ###    ##  ###    ###    ###         ###    ###  ### t##   ###   ###   
#      G##    #   ###    ###   ##     ##  ###    ###    ###         ###    ###  ### ###   ##W         
#      ###        ###    ###   ##    ###  ###    ###    ###         ##L    ##   ### ##   ###          
#      ###        ###    ###  K##    ###  ###    ###    ###         ##     ##    #####   ###          
#      ###       ,##     ###  ###    ###  ###   ###,    ##         G##    ###    ####    ###          
#     W##        ###     ###  ###    ###  #########     ##         ##########    ####    ###          
#     ###        ###     ###  ###    ###  ########     ###         ##########    ###i   K##           
#     ###        ###     ###  ###    ##  #######       ###         ###    ###    ####   ###           
#     ###        ###     ###  ##     ##  ###           ###         ###    ###   ##W##   ###           
#     ###        ###     ##i  ##    ###  ###           ###         ###    ##    ## ##   ###           
#     ###        ###    ###  ,##    ###  ###           ###         ##     ##   ### ##   ###           
#     ###    ### ###    ###  K##    ###  ###           ##         t##    ###   ##  ###  ###    ###    
#     ###   G##i ###   ###   .##   ###.  ##t           ##         ###    ###  ###  ###  W##,   ###    
#      ########  W##W#####    ########   ##           ###         ###    ###  ##    ##   ####W###     
#      #######    #######     #######   ###           ###         ###    ### ###    ##.  #######      
#       #####      #####       #####    ###           ###         ###    ### ##W    ###   #####       
#                    ###                                                                              
#                    ###                                                                              
#                    #####                                                                            
#                     ####                                                                            
#                       K                                                                             
